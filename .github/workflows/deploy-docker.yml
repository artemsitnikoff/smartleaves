name: Deploy to Production (Docker)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Deploy to server via SSH
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          cd /var/www/smartleaves

          # –ü–æ–¥—Ç—è–Ω—É—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
          git pull origin main

          # –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
          docker-compose -f docker-compose.prod.yml down

          # –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –æ–±—Ä–∞–∑—ã
          docker-compose -f docker-compose.prod.yml build --no-cache

          # –ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
          docker-compose -f docker-compose.prod.yml up -d

          # –û—á–∏—Å—Ç–∏—Ç—å –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –æ–±—Ä–∞–∑—ã
          docker image prune -af

          # –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å
          docker-compose -f docker-compose.prod.yml ps

          echo "‚úÖ Deployment completed!"

    - name: Notify on success
      if: success()
      run: echo "üöÄ Deployment successful!"

    - name: Notify on failure
      if: failure()
      run: echo "‚ùå Deployment failed!"
